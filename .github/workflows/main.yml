name: Perpetual

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-vds]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 355

    steps:
      - name: Setup SSH Server and Tunnel
        env:
          VDS_IP: ${{ secrets.VDS_IP }}
          VDS_USER: ${{ secrets.VDS_USER }}
          VDS_PASSWORD: ${{ secrets.VDS_PASSWORD }}
        run: |
          # Устанавливаем необходимые пакеты
          sudo apt-get update && sudo apt-get install -y openssh-server sshpass

          # Настраиваем SSH-сервер на воркере
          # !!! ЗАМЕНИ 'YourStrongPasswordHere' НА СВОЙ ПАРОЛЬ ДЛЯ ПОДКЛЮЧЕНИЯ !!!
          sudo useradd -m -s /bin/bash doxile && echo "doxile:YourStrongPasswordHere" | sudo chpasswd
          # Правильная команда для добавления пользователя в группу sudo
          sudo usermod -aG sudo doxile
          sudo service ssh start

          # Запускаем обратный туннель с помощью sshpass
          # Правильная команда с флагами -f (фон), -N (без команд) и -R (реверс-туннель)
          sshpass -p "${VDS_PASSWORD}" ssh -f -N -R 0.0.0.0:2222:localhost:22 ${VDS_USER}@${VDS_IP} -o StrictHostKeyChecking=no

      - name: Display Connection Info
        env:
          VDS_IP: ${{ secrets.VDS_IP }}
        run: |
          echo "========================================================================="
          echo "Linux Server is ready! It will restart automatically."
          echo "Connection Method: Password Auth"
          echo ""
          echo "SSH command to connect:"
          echo "ssh doxile@${VDS_IP} -p 2222"
          echo ""
          echo "Password: YourStrongPasswordHere"
          echo "========================================================================="
      
      - name: Keep Alive
        run: |
          sleep 20700 # ~5 часов 45 минут

      - name: Trigger Next Run (Auto-Restart)
        # Этот шаг сработает, только если предыдущие шаги были успешными
        if: success()
        run: |
          echo "Workflow completed successfully. Triggering next run..."
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.VDS_PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/dispatches" \
            -d '{"event_type": "restart-vds"}'
