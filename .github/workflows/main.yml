name: Perpetual Linux Server

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-vds]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 355 # 5 часов 55 минут

    steps:
      - name: Setup SSH Server and Tunnel
        env:
          VDS_IP: ${{ secrets.VDS_IP }}
          VDS_USER: ${{ secrets.VDS_USER }}
          VDS_SSH_PRIVATE_KEY: ${{ secrets.VDS_SSH_PRIVATE_KEY }}
        run: |
          # Настраиваем SSH-сервер на воркере
          sudo apt-get update && sudo apt-get install -y openssh-server
          # !!! ЗАМЕНИ 'YourStrongPasswordHere' НА СВОЙ ПАРОЛЬ !!!
          sudo useradd -m -s /bin/bash doxile && echo "doxile:YourStrongPasswordHere" | sudo chpasswd
          sudo usermod -aG sudo doxile
          sudo service ssh start

          # Настраиваем SSH-клиент для создания туннеля
          mkdir -p ~/.ssh
          echo "${VDS_SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${VDS_IP}" >> ~/.ssh/known_hosts

          # Запускаем обратный туннель в фоновом режиме
          # Порт 2222 - для SSH. Можешь добавить еще порты, если нужно.
          ssh -f -N -R 0.0.0.0:2222:localhost:22 ${VDS_USER}@${VDS_IP}

      - name: Display Connection Info
        env:
          VDS_IP: ${{ secrets.VDS_IP }}
        run: |
          echo "========================================================================="
          echo "Linux Server is ready! It will restart automatically."
          echo ""
          echo "SSH command to connect:"
          echo "ssh doxile@${VDS_IP} -p 2222"
          echo ""
          echo "Password: YourStrongPasswordHere"
          echo "========================================================================="
      
      - name: Keep Alive
        run: |
          sleep 20700 # ~5 часов 45 минут

      - name: Trigger Next Run (Auto-Restart)
        if: success()
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.VDS_PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/dispatches" \
            -d '{"event_type": "restart-vds"}'
